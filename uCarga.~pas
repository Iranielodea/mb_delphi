unit uCarga;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, ComCtrls, ExtCtrls, StdCtrls, Mask, DBCtrls, DB, Buttons,
  FMTBcd, SqlExpr, MaskUtils, ppProd, ppClass, ppReport, ppComm, ppRelatv,
  ppDB, ppTxPipe, ppBands, ppCtrls, ppPrnabl, ppCache, ppStrtch, ppMemo, ppViewr,
  ppModule, raCodMod, ppVar, ppEndUsr;

type
  TfCarga = class(TForm)
    PageControl1: TPageControl;
    Panel1: TPanel;
    TabSheet1: TTabSheet;
    TabSheet2: TTabSheet;
    Panel2: TPanel;
    Panel3: TPanel;
    dsCad: TDataSource;
    Panel4: TPanel;
    Label1: TLabel;
    id_Carga: TDBEdit;
    Num_Carga: TDBEdit;
    Label2: TLabel;
    Letra: TDBEdit;
    Label11: TLabel;
    Visto: TDBEdit;
    Label12: TLabel;
    Label13: TLabel;
    Data: TDBEdit;
    Panel5: TPanel;
    Label3: TLabel;
    Label4: TLabel;
    Label5: TLabel;
    Cod_For: TDBEdit;
    Nome_For: TDBEdit;
    Cod_Cliente: TDBEdit;
    Nome_Cliente: TDBEdit;
    Cod_Contato: TDBEdit;
    Nome_Contato: TDBEdit;
    Label7: TLabel;
    Num_Pedido: TDBEdit;
    Panel6: TPanel;
    Label6: TLabel;
    Label8: TLabel;
    Label10: TLabel;
    DBEdit13: TDBEdit;
    DBEdit14: TDBEdit;
    Valor_Carrega: TDBEdit;
    SpeedButton2: TSpeedButton;
    SpeedButton1: TSpeedButton;
    SpeedButton3: TSpeedButton;
    SpeedButton4: TSpeedButton;
    Label19: TLabel;
    butNovo: TBitBtn;
    butSalvar: TBitBtn;
    butSair: TSpeedButton;
    butImprimir: TSpeedButton;
    butExcluir: TBitBtn;
    Qpesq: TSQLQuery;
    QpesqQTDE: TIntegerField;
    EditId_Carga: TEdit;
    QSaldo: TSQLQuery;
    QSaldoQTDE_ENTREGUE: TFloatField;
    Label20: TLabel;
    DBEdit2: TDBEdit;
    Label21: TLabel;
    DBEdit3: TDBEdit;
    butCond: TSpeedButton;
    QPedido: TSQLQuery;
    QPedidoVALOR_LUCRO: TFloatField;
    butConfig: TBitBtn;
    QPesqCarga: TSQLQuery;
    QPesqCargaID_CARGA: TIntegerField;
    butVerPedido: TBitBtn;
    butAutoriza: TBitBtn;
    QAuto: TSQLQuery;
    QAutoENDERECO: TStringField;
    QAutoNUMERO: TStringField;
    QAutoCEP: TStringField;
    QAutoCNPJ: TStringField;
    QAutoINSC_ESTADUAL: TStringField;
    QAutoDESC_CIDADE: TStringField;
    QAutoSIGLA: TStringField;
    Cod_Motorista: TDBEdit;
    Nome_Motorista: TDBEdit;
    Label15: TLabel;
    SpeedButton5: TSpeedButton;
    Placa: TDBEdit;
    Label16: TLabel;
    Cod_Agencia: TDBEdit;
    Label17: TLabel;
    Nome_Agencia: TDBEdit;
    SpeedButton6: TSpeedButton;
    Panel8: TPanel;
    Label9: TLabel;
    Label14: TLabel;
    Label18: TLabel;
    Valor_Frete: TDBEdit;
    Qtde: TDBEdit;
    Label22: TLabel;
    ValorDif: TEdit;
    QMot: TSQLQuery;
    Qpesq1: TSQLQuery;
    Qpesq1N_CARGA: TIntegerField;
    DBRadioGroup1: TDBRadioGroup;
    QMotCONTATO: TStringField;
    EditSaldo: TDBEdit;
    Label23: TLabel;
    MemoArmazem: TDBMemo;
    MemoObs: TMemo;
    DBMemo1: TDBMemo;
    Label24: TLabel;
    QAutoCOMPLEMENTO: TStringField;
    txtDoc: TppTextPipeline;
    Rel: TppReport;
    Cidade_Data: TppField;
    txtDocppField2: TppField;
    txtDocppField3: TppField;
    txtDocppField7: TppField;
    txtDocppField8: TppField;
    txtDocppField9: TppField;
    txtDocppField1: TppField;
    ppTitleBand1: TppTitleBand;
    ppDBText1: TppDBText;
    ppDBText2: TppDBText;
    ppLabel1: TppLabel;
    ppLabel2: TppLabel;
    ppLabel3: TppLabel;
    ppDBMemo1: TppDBMemo;
    ppLabel4: TppLabel;
    ppDBText3: TppDBText;
    ppLine1: TppLine;
    ppDetailBand1: TppDetailBand;
    ppFooterBand1: TppFooterBand;
    varNome: TppVariable;
    ppLine2: TppLine;
    varEnd: TppVariable;
    varCnpj: TppVariable;
    varIE: TppVariable;
    raCodeModule1: TraCodeModule;
    butConfigAut: TBitBtn;
    desAutoriza: TppDesigner;
    txtDocppField4: TppField;
    txtDocppField5: TppField;
    txtDocppField6: TppField;
    txtDocppField10: TppField;
    QMotCPF: TStringField;
    QMotESTADO_CPF: TStringField;
    QMotPLACA_REBOQUE1: TStringField;
    QMotPLACA_REBOQUE2: TStringField;
    Label25: TLabel;
    CboUnidade: TDBComboBox;
    Compl: TDBEdit;
    Label26: TLabel;
    procedure butSairClick(Sender: TObject);
    procedure dsCadStateChange(Sender: TObject);
    procedure butNovoClick(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FormActivate(Sender: TObject);
    procedure Nome_ClienteExit(Sender: TObject);
    procedure Nome_ContatoExit(Sender: TObject);
    procedure SpeedButton3Click(Sender: TObject);
    procedure SpeedButton4Click(Sender: TObject);
    procedure SpeedButton2Click(Sender: TObject);
    procedure Num_PedidoExit(Sender: TObject);
    procedure Cod_ContatoExit(Sender: TObject);
    procedure Nome_ForExit(Sender: TObject);
    procedure Nome_MotoristaExit(Sender: TObject);
    procedure Nome_AgenciaExit(Sender: TObject);
    procedure SpeedButton6Click(Sender: TObject);
    procedure SpeedButton1Click(Sender: TObject);
    procedure SpeedButton5Click(Sender: TObject);
    procedure butSalvarClick(Sender: TObject);
    procedure FormKeyPress(Sender: TObject; var Key: Char);
    procedure FormKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure butExcluirClick(Sender: TObject);
    procedure butImprimirClick(Sender: TObject);
    procedure Valor_FreteExit(Sender: TObject);
    procedure QtdeExit(Sender: TObject);
    procedure butCondClick(Sender: TObject);
    procedure butConfigClick(Sender: TObject);
    procedure butVerPedidoClick(Sender: TObject);
    procedure DataExit(Sender: TObject);
    procedure butAutorizaClick(Sender: TObject);
    procedure MemoObsEnter(Sender: TObject);
    procedure MemoObsExit(Sender: TObject);
    procedure RelPreviewFormCreate(Sender: TObject);
    procedure butConfigAutClick(Sender: TObject);
    procedure CboUnidadeChange(Sender: TObject);
  private
    { Private declarations }
    procedure Pesquisa_Letra;
    procedure PesquisaCarga(inCodigo: String);
    procedure Altera_Visto;
    procedure Dados_Pedido(inPedido: String);
    procedure Saldo;
    procedure Calcula_Lucro(Tipo: String);
    procedure Busca_Agencia;
    function ValidaCarga: Boolean;
    procedure Dados_Obs(Tipo: string);
    procedure TipoUnidade;
  public
    { Public declarations }
  end;

var
  fCarga: TfCarga;

implementation

uses uDM, UUtil, uDMRegra, uFornecedor, uCliente, uMotorista, uAgenciador,
  uPesqPedido, uParcelas, uRCarga, uPedido;

{$R *.dfm}

procedure TfCarga.butSairClick(Sender: TObject);
begin
   close;
end;

procedure TfCarga.dsCadStateChange(Sender: TObject);
begin
   butNovo.Enabled:=dsCad.DataSet.State in [dsBrowse];
   butImprimir.Enabled:=dsCad.DataSet.State in [dsBrowse];
   butCond.Enabled:=dsCad.DataSet.State in [dsBrowse];
   butSalvar.Enabled:=dsCad.DataSet.State in [dsEdit, dsInsert];
   butExcluir.Enabled:=dsCad.DataSet.State in [dsBrowse];
   butAutoriza.Enabled:=dsCad.DataSet.State in [dsBrowse];
end;

procedure TfCarga.Pesquisa_Letra;
begin
   dmRegra.Pesquisa_Letra(trim(Data.Text),Cod_Motorista.Text,Num_Pedido.Text);
end;

procedure TfCarga.butNovoClick(Sender: TObject);
begin
   MemoObs.Clear;
   dmRegra.Get_Obs('0','CAR');
   dm.Carga.Append;
   TipoUnidade;
   Nome_Motorista.SetFocus;
end;

procedure TfCarga.FormClose(Sender: TObject; var Action: TCloseAction);
begin
   if not (dsCad.DataSet.State in [dsInsert]) then
   begin
      if ValidaCarga = false then
      begin
         action:=canone;
         exit;
      end;
   end;

   if dsCad.DataSet.State in [dsedit,dsinsert] then
      dscad.DataSet.Cancel;
   dscad.DataSet.Close;
   dm.Cad_Obs.Close;
end;

procedure TfCarga.FormActivate(Sender: TObject);
begin
//   dm.Tamanho_Form(fCarga);
   butConfig.Visible:=vgUsuario = 'SUPERVISOR';
   butConfigAut.Visible:=vgUsuario = 'SUPERVISOR';

   if EditId_Carga.Text = '' then
   begin
      PesquisaCarga('0');
      butNovoClick(self);
   end
   else begin
      PesquisaCarga(EditId_Carga.Text);
      Saldo;
      Calcula_Lucro('N');
      
      dmRegra.Get_Obs(dm.CargaID_CARGA.Text,'CAR');
      Dados_Obs('M');
   end;
end;

procedure TfCarga.PesquisaCarga(inCodigo: String);
begin
   dm.Carga.Close;
   dm.Carga.Params[0].Text:=vgCod_Empresa;
   dm.Carga.Params[1].Text:=inCodigo;
   dm.Carga.open;
end;

procedure TfCarga.Altera_Visto;
begin
   dmRegra.Altera_Visto(Cod_Cliente.Text,Cod_Contato.Text);
end;

procedure TfCarga.Nome_ClienteExit(Sender: TObject);
begin
   if Nome_Cliente.Modified then
   begin
      dmRegra.PesquisaCliente(Nome_Cliente.Text);
      dm.CargaCOD_CLIENTE.Text:=dm.ClienteCOD_CLIENTE.Text;
      dm.CargaNOME_CLIENTE.Text:=dm.ClienteNOME.Text;
      dm.Cliente.Close;
      fCliente.Free;
      Altera_Visto;
      Nome_Cliente.Modified:=false;
   end;
end;

procedure TfCarga.Nome_ContatoExit(Sender: TObject);
begin
   if Nome_Contato.Modified then
   begin
      dmRegra.PesquisaCliente(Nome_Contato.Text);
      dm.CargaCOD_CONTATO.Text:=dm.ClienteCOD_CLIENTE.Text;
      dm.CargaNOME_CONTATO.Text:=dm.ClienteNOME.Text;
      dm.Cliente.Close;
      fCliente.Free;
      Altera_Visto;
      Nome_Contato.Modified:=false;
   end;
end;

procedure TfCarga.SpeedButton3Click(Sender: TObject);
begin
   if dmRegra.PesquisaCliente('') = true then
   begin
      DM.ModoEdicao(dsCad);
      dm.CargaCOD_CLIENTE.Text:=dm.ClienteCOD_CLIENTE.text;
      dm.CargaNOME_CLIENTE.Text:=dm.ClienteNOME.Text;
      Altera_Visto;
   end;
   dm.Cliente.Close;
   fCliente.Free;
end;

procedure TfCarga.SpeedButton4Click(Sender: TObject);
begin
   if dmRegra.PesquisaCliente('') = true then
   begin
      DM.ModoEdicao(dsCad);
      dm.CargaCOD_CONTATO.Text:=dm.ClienteCOD_CLIENTE.text;
      dm.CargaNOME_CONTATO.Text:=dm.ClienteNOME.Text;
      Altera_Visto;
   end;
   dm.Cliente.Close;
   fCliente.Free;
end;

procedure TfCarga.Dados_Pedido(inPedido: String);
begin
   dm.Pedido.Close;
   dm.Pedido.Params[0].Text:=vgCod_Empresa;
   dm.Pedido.Params[1].Text:=inPedido;
   dm.Pedido.Open;
   if dm.Pedido.IsEmpty then
      mensagem('Pedido não Existe');

   dm.CargaNUM_PEDIDO.Text:=dm.PedidoNUM_PEDIDO.Text;
   dm.CargaQTDE_PEDIDO.AsFloat:=dm.PedidoTOTAL_QTDE.AsFloat;
   dm.CargaVALOR_PEDIDO.AsFloat:=dm.PedidoTOTAL_LIQUIDO.AsFloat;
   dm.CargaCOD_FOR.Text:=dm.PedidoCOD_FOR.Text;
   dm.CargaNOME_FORNECEDOR.Text:=dm.PedidoNOME_FOR.Text;

   dm.CargaCOD_CLIENTE.Text:=dm.PedidoCOD_CLIENTE.Text;
   dm.CargaNOME_CLIENTE.Text:=dm.PedidoNOME.Text;

   dm.CargaCOD_CONTATO.Text:=dm.PedidoCOD_CONTATO.Text;
   if Cod_Contato.Text <> '' then
   begin
      dmRegra.Get_Codigo(dm.QCliente,Cod_Contato.Text);
      dm.CargaNOME_CONTATO.Text:=dm.QClienteNOME.Text;
      dm.QCliente.Close;
      Cod_Contato.Modified:=false;
   end;

   if not dm.Pedido.IsEmpty then
   begin
      Altera_Visto;
      Pesquisa_Letra;
      Saldo;
      Calcula_Lucro('T');
      Nome_Contato.SetFocus;
   end
   else
      Num_Pedido.SetFocus;

   dm.Pedido.close;
end;

procedure TfCarga.SpeedButton2Click(Sender: TObject);
begin
   fpesqPedido:=TfpesqPedido.create(self);
   fPesqPedido.EditConsulta.Text:='S';
   if fpesqPedido.showModal = mrOk then
      dm.ModoEdicao(dsCad);
   fpesqPedido.Pedido.close;
   fpesqPedido.free;
end;

procedure TfCarga.Saldo;
begin
   dmRegra.Saldo_Carga(id_Carga.Text,Num_Pedido.Text);
{
   if not (dm.Carga.State = dsInsert) then
      exit;

   Qsaldo.Close;
   Qsaldo.Params[0].text:=vgCod_Empresa;
   if dm.Carga.State = dsInsert then
      Qsaldo.Params[1].text:=id_Carga.Text
   else
      Qsaldo.Params[1].text:='0';
   Qsaldo.Params[2].text:=Num_Pedido.Text;
   Qsaldo.Open;

   if dm.Carga.State = dsInsert then
   begin
      if dm.CargaQTDE.AsFloat = 0 then
         dm.CargaQTDE.AsFloat:=dm.CargaQTDE_PEDIDO.AsFloat - QSaldoQTDE_ENTREGUE.AsFloat;
   end;
   dm.cargaSALDO.asfloat:=dm.CargaQTDE_PEDIDO.AsFloat - QSaldoQTDE_ENTREGUE.AsFloat - dm.CargaQTDE.AsFloat;
   Qsaldo.Close;
}
end;

procedure TfCarga.Num_PedidoExit(Sender: TObject);
begin
   if Num_Pedido.Modified then
      Dados_Pedido(Num_Pedido.Text);
   Num_Pedido.Modified:=false;
end;

procedure TfCarga.Cod_ContatoExit(Sender: TObject);
begin
//tetes
end;

procedure TfCarga.Nome_ForExit(Sender: TObject);
begin
   if Nome_For.Modified then
   begin
      dmRegra.PesquisaFornecedor(Nome_For.Text);
      dm.CargaCOD_FOR.Text:=dm.FornecedorCOD_FOR.Text;
      dm.CargaNOME_FORNECEDOR.Text:=dm.FornecedorNOME.Text;
      dm.Fornecedor.Close;
      ffornecedor.Free;
      Nome_For.Modified:=false;
   end;
end;

procedure TfCarga.Nome_MotoristaExit(Sender: TObject);
begin
   if Nome_Motorista.Modified then
   begin
      dmRegra.PesquisaMotorista(Nome_Motorista.Text);
      dm.CargaCOD_MOTORISTA.Text:=dm.MotoristaCOD_MOTORISTA.Text;
      dm.CargaNOME_MOTORISTA.Text:=dm.MotoristaNOME.Text;
      dm.CargaPLACA.Text:=dm.MotoristaPLACA.Text;
      dm.Motorista.Close;
      fMotorista.Free;
      Busca_Agencia;
      if Num_Pedido.Text <> '' then
      begin
         Num_Pedido.Modified:=true;
         Num_PedidoExit(self);

      end;
      Nome_Motorista.Modified:=false;
   end;
end;

procedure TfCarga.Nome_AgenciaExit(Sender: TObject);
begin
{
   if Nome_Agencia.Modified then
   begin
      dmRegra.PesquisaAgenciador(Nome_Agencia.Text);
      dm.CargaCOD_AGENCIA.Text:=dm.AgenciadorCOD_AGENCIA.Text;
      //dm.CargaNOME_AGENCIA.Text:=dm.AgenciadorNOME.Text;
      dm.Agenciador.Close;
      fAgenciador.Free;
      Nome_Agencia.Modified:=false;
   end;
}
end;

procedure TfCarga.SpeedButton6Click(Sender: TObject);
begin
   if dmRegra.PesquisaAgenciador('') = true then
   begin
      DM.ModoEdicao(dsCad);
      dm.CargaCOD_AGENCIA.Text:=dm.AgenciadorCOD_AGENCIA.text;
      //dm.CargaNOME_AGENCIA.Text:=dm.AgenciadorNOME.Text;
   end;
   dm.Agenciador.Close;
   fAgenciador.Free;
end;

procedure TfCarga.SpeedButton1Click(Sender: TObject);
begin
   if dmRegra.PesquisaFornecedor('') = true then
   begin
      DM.ModoEdicao(dsCad);
      dm.CargaCOD_FOR.Text:=dm.FornecedorCOD_FOR.text;
      dm.CargaNOME_FORNECEDOR.Text:=dm.FornecedorNOME.Text;
   end;
   dm.Fornecedor.Close;
   fFornecedor.Free;
end;

procedure TfCarga.SpeedButton5Click(Sender: TObject);
begin
   if dmRegra.PesquisaMotorista('') = true then
   begin
      DM.ModoEdicao(dsCad);
      dm.CargaCOD_MOTORISTA.Text:=dm.MotoristaCOD_MOTORISTA.text;
      dm.CargaNOME_MOTORISTA.Text:=dm.MotoristaNOME.Text;
      dm.CargaPLACA.Text:=dm.MotoristaPLACA.Text;
      Altera_Visto;
      Busca_Agencia;

      Num_Pedido.Modified:=true;
      Num_PedidoExit(self);
   end;
   dm.Motorista.Close;
   fMotorista.Free;
end;

procedure TfCarga.butSalvarClick(Sender: TObject);
var vlOper: String[1];
begin
   if trim(Num_Carga.Text) = '' then
   begin
      mensagem('Informe o número da carga');
      Num_Carga.SetFocus;
      exit;
   end;

   if trim(Data.Text) = '' then
   begin
      mensagem('Informe a data da emissão');
      Data.SetFocus;
      exit;
   end;

   if trim(Cod_Contato.Text) = '' then
   begin
      mensagem('Informe o Contato');
      Nome_Contato.SetFocus;
      exit;
   end;

   if trim(Num_Pedido.Text) = '' then
   begin
      mensagem('Informe o número do pedido');
      Num_Pedido.SetFocus;
      exit;
   end;

   if (dm.CargaVALOR_FRETE.AsFloat) <= 0 then
   begin
      mensagem('Informe o valor do frete');
      Valor_Frete.SetFocus;
      exit;
   end;

   if (dm.CargaQTDE.AsFloat) <= 0 then
   begin
      mensagem('Informe a quantidade');
      Qtde.SetFocus;
      exit;
   end;

   QpesqCarga.Close;
   QpesqCarga.Params[0].Text:=Num_Carga.Text;
   QpesqCarga.Params[1].Text:=Letra.Text;
   QpesqCarga.Params[2].Text:=id_Carga.Text;
   QpesqCarga.Open;
   if not QpesqCarga.IsEmpty then
   begin
      QpesqCarga.Close;
      mensagem('Número da Carga já Existe, Escolha outro número');
      Exit;
   end;
   QpesqCarga.Close;
   vlOper:='I';
   if dm.Carga.State = dsEdit then
      vlOper:='A';

   dm.IniTrans;
   dm.Carga.Post;

   if vlOper = 'A' then
      dmRegra.ContasCarga(id_Carga.Text,'C');

   dm.SalvaTab(dm.Carga);
   if dm.CargaSITUACAO.Text = 'C' then
      ExecutaSql('delete from CONTAS where COD_EMPRESA = '+vgCod_Empresa+' and NUM_PEDIDO = '+id_Carga.text+' and TIPO_CONTA = 2');
      
   Dados_Obs('I');

   dm.SalvaTrans;
   Saldo;
   if vlOper = 'I' then
      butCondClick(self);
end;

procedure TfCarga.FormKeyPress(Sender: TObject; var Key: Char);
begin
   if key = #13 then
   begin
      key:=#0;
      perform(Wm_NextDlgCtl,0,0);
   end;
end;

procedure TfCarga.FormKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
   case key of
      vk_F2: begin
               if butNovo.Enabled then
                  butNovoClick(self);
             end;
      vk_F4: begin
               if butExcluir.Enabled then
                  butExcluirClick(self);
             end;
      vk_F6: begin
               if butSalvar.Enabled then
                  butSalvarClick(self);
             end;
      vk_F7: begin
               if butCond.Enabled then
                  butCondClick(self);
             end;
      vk_F8: begin
               if butImprimir.Enabled then
                  butImprimirClick(self);
             end;
      vk_Escape: close;

   end;
end;

procedure TfCarga.butExcluirClick(Sender: TObject);
begin
   if Confirma('Confirma Exclusão desta Carga?','N')=idno then
      exit;
   try
      if dm.permite(vgUsuario,'E','CARGA') = false then
         exit;
      dmRegra.Excluir_Carga(dm.CargaID_CARGA.Text);
      dm.SalvaTrans;
   except
      dm.Carga.CancelUpdates;
      dm.CancelaTrans;
   end;
   close;
end;

procedure TfCarga.butImprimirClick(Sender: TObject);
begin
   frCarga:=TfrCarga.create(self);
   with frCarga do
   begin
      frCarga.EditValorUnit.Text:=ValorDif.Text;
      carga.Close;
      Carga.Params[0].Text:=dm.CargaID_CARGA.Text;
      Carga.Open;

      OutrasCargas(Num_Carga.Text, vgCod_Empresa);

      Rel.Template.FileName:='Carga.rtm';
      Rel.Template.LoadFromFile;

      Rel.Print;
      Carga.Close;
      free;
   end;
end;

procedure TfCarga.Calcula_Lucro(Tipo: String);
begin
// Tipo = T-Tudo
   ValorDif.Text:=dmRegra.Calcula_Lucro(Num_Pedido.Text,Tipo);
end;

procedure TfCarga.Valor_FreteExit(Sender: TObject);
begin
   if Valor_Frete.Modified then
   begin
      Calcula_Lucro('T');
      Valor_Frete.Modified:=false;
   end;
end;

procedure TfCarga.QtdeExit(Sender: TObject);
begin
   if Qtde.Modified then
   begin
      Calcula_Lucro('T');
      Saldo;
      Qtde.Modified:=false;
   end;
end;

procedure TfCarga.butCondClick(Sender: TObject);
begin
   fParcelas:=TfParcelas.create(Self);
   fParcelas.ValorPedido.Text:=formatfloat(',#0.00',dm.CargaVALOR_CARREGA.AsFloat);
   fParcelas.DataEmissao.Text:=Data.Text;
   fParcelas.editNumPedido.Text:=Num_Pedido.Text;
   fParcelas.EditNumCarga.Text:=id_Carga.Text;
   fParcelas.editCarga.Text:='S';
   fParcelas.showModal;
   fParcelas.free;
end;

procedure TfCarga.butConfigClick(Sender: TObject);
begin
   frCarga:=TfRCarga.create(Self);
   fRCarga.desRel.Show;

end;

procedure TfCarga.butVerPedidoClick(Sender: TObject);
begin
   if Num_Pedido.Text <> '' then
   begin
      fPedido:=TfPedido.create(self);
      fPedido.Num_Pedido.Text:=NUM_PEDIDO.Text;
      fPedido.Operacao.Text:='ALTERAR';
      fPedido.showModal;
      fPedido.free;
   end;
end;

procedure TfCarga.DataExit(Sender: TObject);
begin
   if dmRegra.VerificaData(Data.Text) = false then
      Data.SetFocus;
end;

procedure TfCarga.butAutorizaClick(Sender: TObject);
var Arq: TextFile;
   vlData:  String;
   vlEnd:   String;
   vlCid:   String;
   vlUf:    String;
   vlCnpj:  String;
   vlInsc:  String;
   vlCep:   String;
   vlPlaca1: String;
   vlPlaca2: String;
   vlCpf:    String;
   vlUF_Cpf: String;
   vlArmazem: String;
   vlQtde:    String;
begin
   if Cod_Cliente.Text = '' then
   begin
      Mensagem('Escolha um cliente');
      exit;
   end;
   QAuto.close;
   Qauto.Params[0].Text:=vgCod_Empresa;
   Qauto.Params[1].Text:=Cod_Cliente.Text;
   Qauto.Open;

   vlCpf:='';
   vlUf_Cpf:='';
   vlPlaca1:='';
   vlPlaca2:='';
   if Cod_Motorista.Text <> '' then
   begin
      Qmot.Close;
      Qmot.Params[0].Text:=Cod_Motorista.text;
      Qmot.Open;
      if not Qmot.IsEmpty then
      begin
         if QMotCPF.Text <> '' then
            vlCpf := 'CPF ' + formatMaskText('###.###.###-##;0;_',QMotCPF.Text);
         if QMotESTADO_CPF.Text <> '' then
            vlUF_Cpf := QMotESTADO_CPF.Text;
         if QMotPLACA_REBOQUE1.Text <> '' then
            vlPlaca1 := ' / ' + QMotPLACA_REBOQUE1.Text;
         if QMotPLACA_REBOQUE2.Text <> '' then
            vlPlaca2 := ' / ' + QMotPLACA_REBOQUE2.Text;
      end;
      Qmot.Close;
   end;

   vlEnd:=QAutoENDERECO.Text+' '+QAutoNUMERO.Text+' '+QAutoCOMPLEMENTO.Text;
   vlCid:=QAutoDESC_CIDADE.Text;
   vlUf:=QAutoSIGLA.Text;
   vlCnpj:=formatMaskText('##.###.###/####-##;0;_',QAutoCNPJ.Text);
   vlInsc:=QautoInsc_Estadual.text;
   vlCep:=formatMaskText('#####-###;0;_',QAutoCEP.Text);
   vlArmazem:=MemoArmazem.Text;
   QAuto.close;

   if CboUnidade.text = 'SACAS' then
      vlQtde := formatfloat(',###', dm.CargaQTDE.AsFloat * 50)
   else
      vlQtde := formatfloat(',###', dm.CargaQTDE.AsFloat * 30);

   vlData:=formatdateTime('dd" de " mmmm "de" yyyy',strtodate(Data.Text));
   assignfile(Arq,'doc.txt');
   rewrite(arq);

   write(Arq,vlCid+' - '+vluf+', '+vlData+'#');
   write(Arq,vlArmazem+'#');
   write(Arq,'     AUTORIZAMOS O SR. '+Nome_Motorista.text+', ' + vlCpf + ' ' + vlUF_Cpf);
   write(Arq,' MOTORISTA DO CAMINHÃO PLACA(S) '+Placa.text + ' ' + vlPlaca1 + ' ' + vlPlaca2 +', A RETIRAR ');
   write(Arq,'PARA A NOSSA EMPRESA A TONELAGEM DE ' + vlQtde + ' KG CORRESPONDENTE A QUANTIDADE DE '+ Qtde.text+' '+CboUnidade.text+' DE AÇÚCAR DE '+ Compl.text+'#');
   write(Arq,Nome_Cliente.text+'#');
   write(Arq,vlEnd+' - CEP '+vlCep+' - '+vlCid+' - '+vlUf+'#');
   write(Arq,'CNPJ - '+vlCnpj+'#');
   write(Arq,'I.E - '+vlInsc+'#');
   closefile(Arq);
   Rel.Template.FileName:='Autoriza.rtm';
   Rel.Template.LoadFromFile;
   Rel.Print;
end;

procedure TfCarga.Busca_Agencia;
begin
   if Cod_Motorista.text <> '' then
   begin
      Qmot.Close;
      Qmot.Params[0].Text:=Cod_Motorista.Text;
      Qmot.Open;
      dm.CargaCONTATO_INDICACAO.Text:=QMotCONTATO.Text;
      Qmot.close;
   end;
end;

function TfCarga.ValidaCarga: Boolean;
begin
   result:=true;
   if dmRegra.ContasCarga(id_Carga.Text,'P') = false then
      result:=true;

end;

procedure TfCarga.Dados_Obs(Tipo: string);
var i: integer;
begin
// Tipo: I-Incluir M-Mostrar

   dm.Cad_Obs.First;
   if Tipo = 'I' then
   begin
      while not dm.Cad_Obs.Eof do
         dm.Cad_Obs.Delete;

      for i:=0 to MemoObs.Lines.Count - 1 do
      begin
         dm.Cad_Obs.Append;
         dm.Cad_ObsCODIGO.Text:=id_Carga.Text;
         dm.Cad_ObsTIPO.Text:='CAR';
         dm.Cad_ObsNUM_LINHA.AsInteger:=i;
         dm.Cad_ObsCODEMPRESA.Text:=vgCod_Empresa;
         dm.Cad_ObsTEXTO.Text:=MemoObs.Lines[i];
         dm.Cad_Obs.Post;
      end;
      dm.SalvaTab(dm.Cad_Obs);
   end
   else begin
      MemoObs.Clear;
      while not dm.Cad_Obs.Eof do
      begin
         MemoObs.Lines.Add(dm.Cad_ObsTEXTO.Text);
         DM.Cad_Obs.Next;
      end;
   end;
end;

procedure TfCarga.MemoObsEnter(Sender: TObject);
begin
   fCarga.KeyPreview:=false;
   MemoObs.Modified:=false;
end;

procedure TfCarga.MemoObsExit(Sender: TObject);
begin
   fCarga.KeyPreview:=true;
   if MemoObs.Modified then
      DM.ModoEdicao(dsCad);
end;

procedure TfCarga.RelPreviewFormCreate(Sender: TObject);
begin
   TPPReport(Sender).PreviewForm.WindowState:=wsMaximized;
   TPPViewer(TPPReport(Sender).PreviewForm.Viewer).ZoomPercentage:=100; // .zoomSetting:=100;//zswholepage;
end;

procedure TfCarga.butConfigAutClick(Sender: TObject);
begin
   desAutoriza.Show;
end;

procedure TfCarga.CboUnidadeChange(Sender: TObject);
begin
   TipoUnidade;
end;

procedure TfCarga.TipoUnidade;
begin
   if CboUnidade.Text = 'SACAS' then
      dm.CargaCOMPLUNIDADE.Text := '50 KG CADA.'
   else
      dm.CargaCOMPLUNIDADE.Text := '30 KG CADA,'
end;

end.
